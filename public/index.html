<!doctype html>
<html>
<head>
</head>
<body>
    
    <input id="imageUpload" type="file" />
    <br>
    <div id="uploadMsg"></div>
    <br>
    <button id="uploadBtn">upload</button>
    
    <br>
    <br>
    <br>
    <h3>Uploads:</h3>
    <div id="uploads_list"></div>


<script>
(function() {
    let uploadMsg = document.getElementById("uploadMsg");

    let file;
    let imageUpload = document.getElementById("imageUpload");
    imageUpload.onchange = function () {
        file = this.files[0];
        if(file){
            uploadMsg.innerHTML = `Upload ${file.name}?`
        }
    };

    let uploadBtn = document.getElementById("uploadBtn");
    uploadBtn.onclick = async function (){
        if(!file){
            uploadMsg.innerHTML = 'No File Selected'
            return;
        }
        uploadMsg.innerHTML = 'Getting s3 upload credentials...'
        let params = await presign_upload({
            file_name: file.name
        })
        console.log(params)
        uploadMsg.innerHTML = `Uploading ${file.name} ...`
        await upload_file_to_s3(params, file)
        await get_bucket_files()
    }


    const presign_upload = function(file_data){
        return new Promise((resolve, reject)=>{
            fetch('/presigned', {
                method: 'POST', 
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(file_data)
            })
            .then((response) => response.json())
            .then((data) => {
                console.log('Success:', data);
                return resolve(data)
            })
            .catch((error) => {
                console.error('Error:', error);
                return reject(data)
            });
        })
    }

    const upload_file_to_s3 = (params, file) => {
        return new Promise((resolve, reject) => {
            const formData = new FormData();
            Object.keys(params.fields).forEach(key => {
                formData.append(key, params.fields[key]);
            });
            formData.append("file", file);

            fetch(params.url, {
                method: 'POST', 
                mode: 'no-cors',
                body: formData
            })
            .then((data) => {
                uploadMsg.innerHTML = `Uploaded ${file.name} Successfully.`
                return resolve(data)
            })
            .catch((error) => {
                return reject(data)
            });
        });
    };


    const get_bucket_files = () => {
        return new Promise((resolve, reject)=>{
            fetch('/list_uploads', {
                method: 'GET', 
                headers: {
                    'Content-Type': 'application/json',
                },
            })
            .then((response) => response.json())
            .then((uploads) => {
                let uploads_list = document.getElementById("uploads_list");
                uploads_list.innerHTML = ''

                uploads.forEach(f=>{
                    let download = document.createElement('div');
                    download.innerHTML = f.Key
                    download.onclick = function() {
                        return download_file(f)
                    }
                    let del = document.createElement('div');
                    del.innerHTML = 'delete'
                    del.onclick = function() {
                        return delete_file(f)
                    }

                    uploads_list.appendChild(download)
                    uploads_list.appendChild(del)
                })
                return resolve()
            })
            .catch((error) => {
                console.error('Error:', error);
                return reject(data)
            });
        })
    };

    const download_file = (f)=>{
        return new Promise((resolve,reject)=>{
            fetch('/download', {
                method: 'POST', 
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(f)
            })
            .then((response) => response.json())
            .then((data) => {
                console.log('Success:', data);
                window.location.assign(data.download_url);

                return resolve(data)
            })
            .catch((error) => {
                console.error('Error:', error);
                return reject(data)
            });
        })
    }

    const delete_file = (f)=>{
        return new Promise((resolve,reject)=>{
            fetch('/delete', {
                method: 'POST', 
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(f)
            })
            .then((response) => response.json())
            .then((data) => {
                console.log('deleted')
                // await get_bucket_files()
                return resolve(data)
            })
            .catch((error) => {
                console.error('Error:', error);
                return reject(data)
            });
        })
    }


    get_bucket_files()
    
})();
</script>
</body>
</html>